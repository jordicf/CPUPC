# (c) Antoni Pech-Alberich 2025
# For the CPUPC Project.
# Licensed under the MIT License (see https://github.com/jordicf/CPUPC/blob/master/LICENSE.txt).

import unittest
import numpy as np
from cpupc.netlist.netlist import Netlist
from tools.floorset_parser.floor_set_manager.manager import FloorSetInstance
from cpupc.geometry.geometry import Point
import tools.floorset_parser.floor_set_manager.utils.utils as fun


class TestFloorSetInstance(unittest.TestCase):
    def setUp(self):
        self.data = {
            "area_blocks": np.array(
                [
                    1024.0,
                    512.0,
                    256.0,
                    768.0,
                    768.0,
                    256.0,
                    768.0,
                    512.0,
                    768.0,
                    3072.0,
                    1536.0,
                    1024.0,
                    2560.0,
                    512.0,
                    2304.0,
                    1024.0,
                    512.0,
                    1920.0,
                    1152.0,
                    2560.0,
                    512.0,
                ]
            ),
            "b2b_connectivity": np.array(
                [
                    [0.000e00, 1.000e00, 128],
                    [0.000e00, 1.600e01, 512],
                    [1.000e00, 1.400e01, 1024],
                    [2.000e00, 4.000e00, 1024],
                    [2.000e00, 1.500e01, 512],
                    [4.000e00, 6.000e00, 512],
                    [8.000e00, 1.100e01, 128],
                    [8.000e00, 1.700e01, 512],
                    [1.100e01, 1.900e01, 512],
                    [1.300e01, 1.700e01, 256],
                    [1.400e01, 1.700e01, 1024],
                    [1.400e01, 1.800e01, 128],
                    [1.700e01, 2.000e01, 256],
                ]
            ),
            "p2b_connectivity": np.array(
                [
                    [1.000e00, 7.000e00, 512],
                    [1.000e00, 1.500e01, 512],
                    [2.000e00, 5.000e00, 512],
                    [3.000e00, 0.000e00, 512],
                    [1.000e01, 1.300e01, 512],
                    [1.000e01, 1.400e01, 512],
                    [1.100e01, 4.000e00, 512],
                    [1.100e01, 1.700e01, 512],
                    [1.200e01, 3.000e00, 512],
                    [1.200e01, 1.400e01, 512],
                ]
            ),
            "pins_pos": np.array(
                [
                    [0.0, 0.0],
                    [33.0, 0.0],
                    [88.0, 0.0],
                    [132.0, 0.0],
                    [143.0, 0.0],
                    [0.0, 160.0],
                    [22.0, 160.0],
                    [88.0, 160.0],
                    [110.0, 160.0],
                    [132.0, 160.0],
                    [143.0, 160.0],
                    [0.0, 11.0],
                    [0.0, 55.0],
                    [0.0, 77.0],
                    [0.0, 121.0],
                    [0.0, 132.0],
                    [0.0, 154.0],
                    [152.0, 11.0],
                    [152.0, 22.0],
                    [152.0, 88.0],
                    [152.0, 154.0],
                ]
            ),
            "placement_constraints": np.array(
                [
                    [0.0, 0.0, 0.0, 3.0, 0.0],
                    [0.0, 0.0, 1.0, 0.0, 8.0],
                    [0.0, 0.0, 2.0, 2.0, 0.0],
                    [0.0, 0.0, 3.0, 1.0, 0.0],
                    [0.0, 0.0, 3.0, 0.0, 0.0],
                    [0.0, 0.0, 2.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 1.0, 1.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                    [1.0, 0.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 6.0],
                    [0.0, 0.0, 0.0, 2.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 5.0],
                    [0.0, 1.0, 1.0, 2.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 10.0],
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 1.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 2.0],
                    [0.0, 0.0, 0.0, 0.0, 2.0],
                    [0.0, 0.0, 0.0, 3.0, 1.0],
                    [0.0, 0.0, 1.0, 3.0, 0.0],
                ]
            ),
            "vertex_blocks": np.array(
                [
                    [
                        [0.0, 0.0],
                        [0.0, 32.0],
                        [32.0, 32.0],
                        [32.0, 0.0],
                        [0.0, 0.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [32.0, 0.0],
                        [32.0, 32.0],
                        [48.0, 32.0],
                        [48.0, 0.0],
                        [32.0, 0.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [48.0, 64.0],
                        [48.0, 80.0],
                        [64.0, 80.0],
                        [64.0, 64.0],
                        [48.0, 64.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [80.0, 64.0],
                        [80.0, 80.0],
                        [128.0, 80.0],
                        [128.0, 64.0],
                        [80.0, 64.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [80.0, 80.0],
                        [80.0, 96.0],
                        [128.0, 96.0],
                        [128.0, 80.0],
                        [80.0, 80.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [48.0, 96.0],
                        [48.0, 112.0],
                        [64.0, 112.0],
                        [64.0, 96.0],
                        [48.0, 96.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [48.0, 112.0],
                        [48.0, 160.0],
                        [64.0, 160.0],
                        [64.0, 112.0],
                        [48.0, 112.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [64.0, 80.0],
                        [80.0, 80.0],
                        [80.0, 48.0],
                        [64.0, 48.0],
                        [64.0, 80.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [64.0, 48.0],
                        [80.0, 48.0],
                        [80.0, 0.0],
                        [64.0, 0.0],
                        [64.0, 48.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [80.0, 160.0],
                        [128.0, 160.0],
                        [128.0, 96.0],
                        [80.0, 96.0],
                        [80.0, 160.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [128.0, 160.0],
                        [152.0, 160.0],
                        [152.0, 96.0],
                        [128.0, 96.0],
                        [128.0, 160.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [64.0, 64.0],
                        [64.0, 0.0],
                        [48.0, 0.0],
                        [48.0, 64.0],
                        [64.0, 64.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [48.0, 160.0],
                        [48.0, 96.0],
                        [32.0, 96.0],
                        [32.0, 112.0],
                        [0.0, 112.0],
                        [0.0, 160.0],
                        [48.0, 160.0],
                    ],
                    [
                        [32.0, 64.0],
                        [48.0, 64.0],
                        [48.0, 32.0],
                        [32.0, 32.0],
                        [32.0, 64.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [152.0, 32.0],
                        [152.0, 0.0],
                        [80.0, 0.0],
                        [80.0, 32.0],
                        [152.0, 32.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [64.0, 160.0],
                        [80.0, 160.0],
                        [80.0, 96.0],
                        [64.0, 96.0],
                        [64.0, 160.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [80.0, 96.0],
                        [80.0, 80.0],
                        [48.0, 80.0],
                        [48.0, 96.0],
                        [80.0, 96.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [152.0, 48.0],
                        [80.0, 48.0],
                        [80.0, 64.0],
                        [128.0, 64.0],
                        [128.0, 96.0],
                        [152.0, 96.0],
                        [152.0, 48.0],
                    ],
                    [
                        [80.0, 48.0],
                        [152.0, 48.0],
                        [152.0, 32.0],
                        [80.0, 32.0],
                        [80.0, 48.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [32.0, 32.0],
                        [0.0, 32.0],
                        [0.0, 112.0],
                        [32.0, 112.0],
                        [32.0, 32.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                    [
                        [32.0, 96.0],
                        [48.0, 96.0],
                        [48.0, 64.0],
                        [32.0, 64.0],
                        [32.0, 96.0],
                        [-1.0, -1.0],
                        [-1.0, -1.0],
                    ],
                ]
            ),
            "metrics": np.array(
                [
                    2.4320000e04,
                    2.1000000e01,
                    2.300000e01,
                    1.3000000e01,
                    1.0000000e01,
                    2.6000000e01,
                    6.528000e03,
                    5.1200000e03,
                ]
            ),
            # [area, num_pins, num_total_nets, num_b2b_nets,
            # num_p2b_nets, num_hardconstraints, b2b_weighted_wl, p2b_weighted_wl]
        }
        self.pol = [
            Point(x, y)
            for x, y in list(self.data["vertex_blocks"][17])
            if x != -1 and y != -1
        ]
        self.recs = fun.rectangle_decomposition(self.pol)

    def test_rectangle_decomposition(self):
        self.assertListEqual(
            self.recs,
            [
                [140.0, 80.0, 24.0, 32.0],
                [104.0, 56.0, 48.0, 16.0],
                [140.0, 56.0, 24.0, 16.0],
            ],
        )

    def test_floorsetinstance_netlist(self, d: float | None = None):
        # I/O as fixed
        fs = FloorSetInstance(self.data, d)
        txt_yaml: str = str(fs.write_yaml_FPEF())
        self.assertIsNotNone(txt_yaml)
        Netlist(txt_yaml)
        # I/O as soft
        fs = FloorSetInstance(self.data, d, True)
        txt_yaml = str(fs.write_yaml_FPEF())
        self.assertIsNotNone(txt_yaml)
        Netlist(txt_yaml)

    def test_compute_perimeter(self):
        per = fun.compute_perimeter(self.pol)
        self.assertIsInstance(per, float)
        self.assertAlmostEqual(per, 240.0, delta=4)

    def test_is_point_inside_polygon(self):
        inside = fun.is_point_inside_polygon(Point(110, 80), self.pol)
        self.assertFalse(inside, "Point not inside the polygon")
        inside = fun.is_point_inside_polygon(Point(140, 60), self.pol)
        self.assertTrue(inside, "Point is inside the polygon")

    def test_compute_centroid(self):
        c = fun.compute_centroid(self.recs)
        self.assertIsInstance(c, Point)
        self.assertAlmostEqual(c, Point(125.6, 65.6), delta=4)


if __name__ == "__main__":
    unittest.main()
